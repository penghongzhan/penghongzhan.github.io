---
title: JIT基本原理
date: 2018-03-22 15:22:03
categories:
- java
tags:
- java
- jit
- jvm
---

---
# JIT简介
---

JVM自动监控这所有方法的执行，如果某个方法是热点方法，JVM就计划把该方法的字节码代码编译成本地机器代码，同时还会在后续的执行过程中进行可能的更深层次的优化，编译成机器代码的过程是在独立线程中执行的，不会影响程序的执行；除次以外，JVM还对热点方法和很小的方法内联到调用方的方法中，减少方法栈的创建。这些就是JIT（just in time 即时编译器）。

JIT的功能能显著提升java程序的性能，尤其是编译为本地代码和内联功能。内联需要方法比较小，也就是说写代码时就尽量把方法写得更小，让方法的复用度更高，复用的越多，就越可能被编译为本地代码。高性能的框架和类库针对JVM的JIT功能进行优化是非常有必要的，JVM提供的调试输出参数和JITWatch这样友好的工具能大大帮助我们快速的发现和定位需要优化的代码，大大提升了效率。

通过在虚拟机中引入了JIT编译器（即时编译器），当虚拟机发现某个方法或代码块运行特别频繁时，就会把这些代码认定为“Hot Spot Code”（热点代码），为了提高热点代码的执行效率，在运行时，虚拟机将会把这些代码编译成与本地平台相关的机器码，并进行各层次的优化，完成这项任务的正是JIT编译器。 在某些情况下，调整好的最佳化 JVM 效能可能超过手工的 C++ 或 C。

现在主流的商用虚拟机（如Sun HotSpot、IBM J9）中几乎都同时包含解释器和编译器。当程序需要迅速启动和执行时，解释器可以首先发挥作用，省去编译的时间，立即执行；当程序运行后，随着时间的推移，编译器逐渐会返回作用，把越来越多的代码编译成本地代码后，可以获取更高的执行效率。解释执行可以节约内存，而编译执行可以提升效率。

---
# 执行模式
---

- client（即C1）：只做少量性能开销比高的优化，占用内存少，适用于桌面程序。
- server（即C2）：进行了大量优化，占用内存多，适用于服务端程序。会收集大量的运行时信息。

**注意：**

- 32为机器默认选择C1，可在启动时添加-client或-server来指定，64位机器若`CPU>2`且物理`内存>2G`则默认为C2，否则为C1
- Hotspot JVM执行代码的机制：对在执行过程中执行频率高的代码进行编译，对执行频率不高的代码继续解释执行

---
# client模式
---

## 方法内联

简单介绍一下client模式中的方法内联，方法内联有如下优点：

- 优化系列中最一开始使用的方式（因为是很多其他优化手段的基础）
- 消除方法调用的成本（建立栈帧、避免参数传递、避免返回值传递、避免跳转）

### 内联之前

```
static class B{
    int value;
    final int get() {
        return value;
    }
}

public void foo() {
    y = b.get();
    z = b.get();
    sum = y + z;
}
```

### 内联之后

```
static class B{
    int value;
    final int get() {
        return value;
    }
}
public void foo() {
    y = b.value;
    z = b.value;
    sum = y + z;
}
```

**参考博客**

- [Java JIT性能调优](http://rongmayisheng.com/post/java-jit%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98)
- [Java中的JIT机制对运行速度的优化](http://blog.csdn.net/pwiling/article/details/51446195)
- [第六章 字节码执行方式--解释执行和JIT](http://www.cnblogs.com/java-zhao/p/5203144.html)
